# .ANTIGRAVITY - AI CODING INSTRUCTIONS

## Gold Manufacturing & Billing ERP System

### Zero-Error Code Generation Protocol

---

## ðŸŽ¯ PROJECT CONTEXT

**System:** Multi-tenant Gold Manufacturing & Billing ERP  
**Framework:** CodeIgniter 4.5+  
**PHP Version:** 8.1+  
**Database:** MySQL 8.0+  
**Architecture:** MVC + Service Layer

**Key Business Rules:**

- Multi-tenant with company_id isolation
- Soft delete (is_deleted flag, never hard delete)
- Append-only ledger (never update/delete ledger_entries)
- Concurrency-safe invoice/challan numbering
- All financial operations in DB transactions
- Tax-inclusive pricing with CGST/SGST/IGST
- Gold adjustment atomic with payment

---

## ðŸš¨ CRITICAL: AI CODING RULES (NEVER VIOLATE)

### Rule 1: NO INCOMPLETE CODE

- Complete implementation of ALL methods
- All edge cases handled
- All error scenarios covered
- All validation rules implemented

### Rule 2: NO BLANK RESPONSES

- If output is too long, break into multiple files
- NEVER respond with "...[truncated]..." or "...[rest of code]..."
- Complete each file fully before moving to next

### Rule 3: NO HALLUCINATED METHODS

- Only use methods that exist in CI4 documentation
- Only call services/models that are defined
- Verify method signatures before using

### Rule 4: NO HARD-CODED VALUES

### Rule 5: ALWAYS USE TRANSACTIONS FOR FINANCIAL OPERATIONS

### Rule 6: ALWAYS FILTER BY company_id

### Rule 7: ALWAYS SOFT DELETE

### Rule 8: NEVER UPDATE LEDGER ENTRIES

### Rule 9: VALIDATE BEFORE PROCESSING

### Rule 10: AUDIT LOG CRITICAL OPERATIONS

## ðŸ“ CODE GENERATION WORKFLOW

### Step 1: UNDERSTAND THE REQUIREMENT

Before writing code, state:

1. What module am I implementing?
2. What is the business purpose?
3. What are the inputs and outputs?
4. What validations are needed?
5. Does this require a transaction?
6. What are the dependencies?

### Step 2: CHECK EXISTING DOCUMENTATION

Reference these files:

- `complete_database_schema.sql` - Table structure
- `SERVICES_ARCHITECTURE.md` - Service methods
- `TASK_MASTER.md` - Implementation details
- PRD - Business rules

### Step 3: GENERATE COMPLETE CODE

Follow this structure for each file type (see examples below)

### Step 4: VALIDATE GENERATED CODE

Before submitting, check:

- âœ… All methods implemented (no TODO comments)
- âœ… All namespaces correct
- âœ… All dependencies injected
- âœ… All validations present
- âœ… Transactions used for financial operations
- âœ… company_id filter applied
- âœ… Soft delete used (not hard delete)
- âœ… Audit logging present
- âœ… Error handling complete
- âœ… Type hints on all parameters and return types

---

## ðŸ” COMMON AI MISTAKES TO AVOID

### Mistake 1: Incomplete Validation

### Mistake 2: Forgetting Error RollbackY

### Mistake 3: Not Checking Existence Before Update/Delete

### Mistake 4: SQL Injection Vulnerability

### Mistake 5: Not Using Type Hints

## ðŸ“‹ PRE-GENERATION CHECKLIST

Before generating code, answer these questions:

### Database Questions

- [ ] What table(s) will be queried?
- [ ] Do I need to join tables?
- [ ] What indexes exist on these tables?
- [ ] Do I need to lock rows (FOR UPDATE)?

### Business Logic Questions

- [ ] What business rules apply?
- [ ] What validations are needed?
- [ ] What are the edge cases?
- [ ] What should happen on error?

### Transaction Questions

- [ ] Is this a financial operation?
- [ ] Do I need to update multiple tables?
- [ ] What is the rollback strategy?

### Security Questions

- [ ] Is company_id filter applied?
- [ ] Is permission checked?
- [ ] Are inputs sanitized?
- [ ] Is SQL injection prevented?

### Audit Questions

- [ ] Should this be audit logged?
- [ ] What data should be captured (before/after)?

---

## ðŸŽ¯ TASK-SPECIFIC INSTRUCTIONS

### When Implementing: Models

1. Define table, primaryKey, allowedFields
2. Set useTimestamps = true
3. Add validation rules
4. Implement applyCompanyFilter() method
5. Override findAll() to apply company filter and is_deleted = false
6. Add relationships (hasMany, belongsTo)
7. Add custom query methods (e.g., getActiveProducts())
8. NO business logic in models (only DB operations)

### When Implementing: Services

1. Inject all dependencies in \_\_construct()
2. Public methods for business operations
3. Private methods for validation and helpers
4. Use transactions for multi-step operations
5. Call AuditService for critical operations
6. Throw specific exceptions (not generic Exception)
7. Return typed values (int for IDs, bool for success, array for lists)
8. Log errors before throwing

### When Implementing: Controllers

1. Extend BaseController
2. Check permissions first (hasPermission())
3. Validate request data (CI4 validation rules)
4. Call service methods (thin controllers)
5. Return JSON responses with status, message, data
6. Use proper HTTP status codes (200, 201, 400, 403, 404, 422, 500)
7. Handle exceptions with try-catch
8. NO business logic in controllers

### When Implementing: Migrations

1. Use CI4 migration syntax
2. Define all columns with proper types
3. Add indexes on foreign keys and frequently queried columns
4. Add foreign key constraints with CASCADE
5. Add unique constraints where needed
6. Include down() method for rollback
7. Test both up() and down() migrations

### When Implementing Views: Frontend Theme

- Prebuilt theme exists: admintheme
- This is the ONLY allowed UI source
- Use it for ALL pages (login, dashboard, forms, CRUD, reports)

Theme setup:

- Move theme to project root: /admintheme
- All assets must load from /admintheme
- Never use CDN frameworks
- Never introduce Bootstrap/Tailwind/new CSS
- Alway use HTML reference for all pages from [admintheme/html/vertical-menu-template/]

Implementation rules:

- Reuse existing layouts, components, and styles only
- Extend theme layout files (header, sidebar, footer)
- Do not create standalone HTML pages
- Do not redesign UI
- Only adapt existing theme structure

CodeIgniter rules:

- Views must be inside app/Views
- Use layout + sections
- Include admintheme assets via base_url('admintheme/...')

If UI structure is missing, assume it exists in admintheme and integrate â€” do not generate a new design

---

## ðŸ” SECURITY CHECKLIST

Before submitting code, verify:

- [ ] SQL injection prevented (use Query Builder or parameterized queries)
- [ ] XSS prevented (escape output, use esc() helper)
- [ ] CSRF tokens validated (CI4 handles automatically for POST)
- [ ] Permissions checked (hasPermission() in controllers)
- [ ] Company isolation enforced (company_id filter)
- [ ] Passwords hashed (never store plain text)
- [ ] Sensitive data not logged
- [ ] File uploads validated (type, size, extension)
- [ ] Rate limiting applied (prevent brute force)

---

## ðŸ› ï¸ ROBUST IMPLEMENTATION WORKFLOW (AVOID COMMON ERRORS)

- Follow Structure from Products Module Files for reference

### 1. Routes (Config/Routes.php)

- Explicitly define verbs: `$routes->get()`, `$routes->post()`, `$routes->delete()`.
- **Do not rely on `add()` or default routing.**
- Match AJAX requests (JS `type`) to Route Verb EXACTLY.
- Group routes by module and apply filters (e.g., `['filter' => 'auth']`).

### 2. Models (App/Models)

- Define `allowedFields` correctly. Missing fields = Silent Failure.
- **Critical:** If `Model::update()` fails silently or returns true but changes nothing, switch to `Builder::update()` in Service.
- Validation rules in Model are good, but Controller/Service validation is safer for complex logic.

### 3. Services (App/Services)

- **Update Logic:**
  - Use `Builder` (`$db->table('...')->update()`) if Model has overhead/issues.
  - **Clean Data:** If using Builder, `unset($data[csrf_token()])` and any headers/unknown fields. Builder crashes on unknown columns.
  - **Handle Checkboxes:** If unchecked, HTML sends nothing. Manually set `0` if key missing, OR use hidden input trick in View.
- **Delete Logic:**
  - Use `Builder` for Soft Delete if Model fails.
- **Transactions:** Always wrap in `transStart()` / `transComplete()` + `transStatus()` check.

### 4. Controllers (App/Controllers)

- **Input:** Use `$this->request->getPost()` but filter/validate data before passing to Service.
- **Feedback:**
  - Form Submit: `return redirect()->back()->with('error', ...)` on failure.
  - AJAX: `return $this->response->setJSON(['status'=>'error', 'message'=>...])`.
- **Flash Messages:** Set `session()->setFlashdata('message/error')`.

### 5. Views (App/Views)

- **Forms:**
  - Always include `<?= csrf_field() ?>`.
  - Add **Alert Blocks** (Success/Error) at top of form context:
    ```php
    <?php if(session()->getFlashdata('error')): ?>
        <div class="alert alert-danger"><?= session()->getFlashdata('error') ?></div>
    <?php endif; ?>
    ```
  - **Checkboxes:** Add `<input type="hidden" name="field" value="0">` BEFORE boolean checkbox to ensure `0` is sent if unchecked.
- **Output:**
  - Use `esc()` safely: `<?= esc((string)$var) ?>` to avoid "Array to string" or type errors if static analysis is strict.
- **JavaScript:**
  - Place in `<?= $this->section('page_js') ?>`.
  - **DataTables:** Use delegated events: `$(document).on('click', '.btn-delete', function() ...)` to handle pagination/redraws.
  - **AJAX:** Set `headers: {'X-Requested-With': 'XMLHttpRequest'}` if needed, and handle CSRF token regeneration if page doesn't reload.

---

## ðŸŽ¯ OUTPUT FORMAT

When generating code, use this format:

```
FILE: app/Services/Invoice/InvoiceService.php
================================================================================

<?php
namespace App\Services\Invoice;

[COMPLETE CODE HERE - NO TRUNCATION]

================================================================================
END OF FILE
```

For multiple files:

```
FILE 1/3: app/Models/InvoiceModel.php
[complete code]

FILE 2/3: app/Services/Invoice/InvoiceService.php
[complete code]

FILE 3/3: app/Controllers/Invoices/InvoiceController.php
[complete code]
```

---

## âš ï¸ FINAL WARNINGS

### What Will Get Your Code REJECTED âŒ

1. Incomplete methods with TODO or "rest of code" comments
2. Hard-coded company_id or other values
3. Financial operations without transactions
4. Missing validation
5. No error handling
6. Ledger entries that can be updated/deleted
7. Hard deletes instead of soft deletes
8. SQL injection vulnerabilities
9. Missing type hints
10. Business logic in controllers or models

### What Makes Code EXCELLENT âœ…

1. Complete implementation
2. All edge cases handled
3. Comprehensive validation
4. Transaction safety
5. Proper error handling
6. Type hints everywhere
7. Audit logging
8. Security best practices
9. Follows CI4 conventions
10. Matches SERVICES_ARCHITECTURE.md specifications

---

## ðŸ“ CODE REVIEW CHECKLIST

After generating code, review:

### Functionality

- [ ] All methods implemented completely
- [ ] All business rules enforced
- [ ] All edge cases handled

### Security

- [ ] SQL injection prevented
- [ ] XSS prevented
- [ ] Permissions checked
- [ ] Company isolation enforced

### Data Integrity

- [ ] Transactions used for financial ops
- [ ] Soft delete used (not hard delete)
- [ ] Ledger is append-only
- [ ] Foreign keys respected

### Code Quality

- [ ] Type hints on all methods
- [ ] Proper namespaces
- [ ] Follows PSR-12 standards
- [ ] No hard-coded values
- [ ] Error handling complete

---

## ðŸ READY TO CODE

When you receive a coding task:

1. Read the task from TASK_MASTER.md
2. Check dependencies (what must be completed first)
3. Review relevant section in SERVICES_ARCHITECTURE.md
4. Check database schema for table structure
5. State your understanding of the requirement
6. List all validations needed
7. List all edge cases
8. Generate COMPLETE code (no truncation)
9. Self-validate against this checklist
10. Output in specified format

---

## ðŸš€ LET'S BUILD PERFECT CODE!

**Remember:**

- NO TRUNCATION
- NO INCOMPLETE CODE
- NO HALLUCINATED METHODS
- COMPLETE IMPLEMENTATION ONLY

**Before asking AI to generate code, always provide:**

1. This .antigravity file as context
2. Relevant section from SERVICES_ARCHITECTURE.md
3. Database schema for involved tables
4. Business rules from PRD
5. Clear, specific requirements

---

## ðŸ“„ END OF .ANTIGRAVITY INSTRUCTIONS

**Version:** 1.0  
**Last Updated:** February 11, 2026  
**Project:** Gold Manufacturing & Billing ERP  
**Framework:** CodeIgniter 4

**ZERO ERRORS. ZERO COMPROMISES. PRODUCTION-READY CODE ONLY.**
